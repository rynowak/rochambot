parameters:
  context: ''
  image: ''
  repository: ''
  serviceConnection: ''

steps:
- task: DockerInstaller@0
  inputs:
    dockerVersion: '17.09.0-ce'
    releaseType: 'edge'

- task: Docker@2
  displayName: Login to ACR
  inputs:
    command: login
    containerRegistry: ${{ parameters.serviceConnection }}

- task: HelmInstaller@1
  inputs:
    helmVersionToInstall: 'latest'

- task: Docker@2
  displayName: Docker Build and Push ${{ parameters.image }}
  inputs:
    command: buildAndPush
    buildContext: ${{ parameters.context }}
    Dockerfile: "${{ parameters.context }}/Dockerfile"
    repository: rochambot/${{ parameters.image }}
    containerRegistry: ${{ parameters.serviceConnection }}
    tags: $(Build.BuildNumber)

- task: HelmDeploy@0
  displayName: Helm Package ${{ parameters.image }}
  inputs:
    command: package
    chartPath: charts/${{ parameters.image }}
    destination: $(Build.ArtifactStagingDirectory)/charts
    version: $(Build.BuildNumber)
    arguments: --app-version $(Build.BuildNumber)
    save: false

- task: PublishBuildArtifacts@1
  displayName: Publish Charts to Artifacts
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)/charts
    artifactName: charts

parameters:
  chart: ''
  releaseName: ''
  serviceConnection: ''

steps:
- checkout: none

- download: ci-pipeline
  artifact: charts

- task: HelmInstaller@1
  inputs:
    helmVersionToInstall: 'latest'

- bash: |
    echo "##vso[task.setvariable variable=chartFilePath]$(ls $(Pipeline.Workspace)/ci-pipeline/charts/${{ parameters.chart }}-*.tgz)"

- task: HelmDeploy@0
  displayName: Helm Upgrade ${{ parameters.chart }}
  inputs:
    connectionType: Kubernetes Service Connection
    kubernetesServiceEndpoint: ${{ parameters.serviceConnection }}
    command: upgrade
    chartType: filepath
    chartPath: $(chartFilePath)
    releaseName: ${{ parameters.releaseName }}
    install: true
    waitForExecution: true
